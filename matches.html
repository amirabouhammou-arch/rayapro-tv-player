<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جدول المباريات الاحترافي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-burgundy: #4a0e0e; 
            --bg-light: #f4eee1; 
            --item-bg: #ffffff;
            --text-color: #2c1810;
            --border-gold: #c5a367;
            --accent-red: #e74c3c;
            --live-green: #2ecc71;
        }

        body.dark-mode {
            --bg-light: #121212; --item-bg: #1e1e1e; --text-color: #e0e0e0;
            --primary-burgundy: #2d0808; --border-gold: #b38b4d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-light);
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            margin: 0; padding: 0; transition: 0.3s;
        }

        header {
            background-color: var(--primary-burgundy);
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        header .app-title { color: white; font-size: 18px; font-weight: bold; flex-grow: 1; margin-right: 15px; }
        header i { color: white; font-size: 20px; cursor: pointer; padding: 10px; }

        .container { padding: 15px; max-width: 600px; margin: auto; }

        .section-title {
            font-size: 14px; font-weight: bold; color: var(--primary-burgundy);
            margin: 20px 0 10px; padding-right: 10px; border-right: 4px solid var(--border-gold);
        }

        .match-card {
            background: var(--item-bg); margin-bottom: 12px;
            border-radius: 6px; border-right: 8px solid var(--primary-burgundy);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden; position: relative; transition: 0.2s;
        }
        .match-card.live { border-right-color: var(--live-green); }
        .match-card.finished { opacity: 0.7; filter: grayscale(0.4); border-right-color: #777; }

        .bell-btn {
            position: absolute; top: 35px; left: 15px; font-size: 18px;
            color: #ccc; cursor: pointer; transition: 0.3s; z-index: 10;
        }
        .bell-btn.active { color: var(--border-gold); animation: ring 0.5s ease; }

        @keyframes ring {
            0% { transform: rotate(0); } 25% { transform: rotate(20deg); }
            50% { transform: rotate(-20deg); } 75% { transform: rotate(10deg); }
            100% { transform: rotate(0); }
        }

        .league-header {
            background: rgba(0,0,0,0.03); padding: 6px;
            font-size: 11px; font-weight: bold; color: var(--border-gold);
            text-align: center; border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .match-content { display: flex; align-items: center; justify-content: space-around; padding: 15px 10px; }
        .team-info { text-align: center; width: 35%; }
        .team-info img { width: 42px; height: 42px; object-fit: contain; }
        .team-info span { display: block; font-size: 13px; font-weight: bold; color: var(--text-color); margin-top: 5px; }

        .match-status { text-align: center; width: 30%; }
        .match-time { font-size: 18px; font-weight: 900; color: var(--primary-burgundy); }
        body.dark-mode .match-time { color: var(--text-color); }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 9px; font-weight: bold; color: white; margin-top: 5px; }
        .badge-live { background: var(--accent-red); animation: pulse 1.5s infinite; }
        .badge-waiting { background: #3498db; }
        .badge-finished { background: #7f8c8d; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .match-details {
            background: rgba(0,0,0,0.02); padding: 8px 15px;
            display: flex; justify-content: space-between; font-size: 10px;
            color: var(--text-color); border-top: 1px dashed rgba(0,0,0,0.08);
        }
    </style>
</head>
<body id="body">

    <header>
        <i class="fas fa-arrow-right" onclick="location.href='index.html'"></i>
        <div class="app-title">جدول المباريات</div>
        <i class="fas fa-bell-slash" id="mainBell" onclick="requestPermission()" title="تفعيل التنبيهات"></i>
    </header>

    <div class="container" id="matchesArea"></div>

    <script>
        if(localStorage.getItem('theme') === 'dark') document.getElementById('body').classList.add('dark-mode');
        
        let reminders = JSON.parse(localStorage.getItem('matchReminders')) || [];

        async function requestPermission() {
            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                document.getElementById('mainBell').className = "fas fa-bell";
                alert("تم تفعيل الإشعارات! اضغط على الجرس بجانب أي مباراة لتذكيرك.");
            }
        }

        async function loadMatches() {
            const area = document.getElementById('matchesArea');
            try {
                const res = await fetch('matches.json?v=' + Date.now());
                const data = await res.json();
                
                const live = [], upcoming = [], finished = [];
                data.forEach(m => {
                    const s = getStatus(m.time);
                    if (s === 'LIVE') live.push(m);
                    else if (s === 'FINISHED') finished.push(m);
                    else upcoming.push(m);
                });

                area.innerHTML = `
                    ${renderSection('بث مباشر الآن', live, 'live')}
                    ${renderSection('مباريات قادمة', upcoming, 'upcoming')}
                    ${renderSection('مباريات انتهت', finished, 'finished')}
                `;
                
                startBackgroundCheck(); // بدء فحص المواعيد في الخلفية
            } catch (e) { area.innerHTML = '<p style="text-align:center;">خطأ في تحميل البيانات</p>'; }
        }

        function getStatus(time) {
            const now = new Date(), [h, m] = time.split(':'), mDate = new Date();
            mDate.setHours(h, m, 0);
            const diff = (now - mDate) / 60000;
            if (diff >= 0 && diff <= 125) return 'LIVE';
            if (diff > 125) return 'FINISHED';
            return 'UPCOMING';
        }

        function renderSection(title, list, type) {
            if (list.length === 0) return '';
            return `<div class="section-title">${title}</div>` + 
                   list.map(m => {
                       const isRemind = reminders.some(r => r.id === (m.team1 + m.time));
                       return `
                        <div class="match-card ${type}">
                            <i class="fas fa-bell bell-btn ${isRemind ? 'active' : ''}" 
                               onclick="toggleReminder(event, '${m.team1}', '${m.team2}', '${m.time}')"></i>
                            <div onclick="window.open('${m.link}', '_blank')">
                                <div class="league-header">${m.league}</div>
                                <div class="match-content">
                                    <div class="team-info">
                                        <img src="${m.logo1}" onerror="this.src='https://via.placeholder.com/50'">
                                        <span>${m.team1}</span>
                                    </div>
                                    <div class="match-status">
                                        <div class="match-time">${m.time}</div>
                                        <div class="badge badge-${type === 'live' ? 'live' : type === 'finished' ? 'finished' : 'waiting'}">
                                            ${type === 'live' ? 'مباشر' : type === 'finished' ? 'انتهت' : 'قريباً'}
                                        </div>
                                    </div>
                                    <div class="team-info">
                                        <img src="${m.logo2}" onerror="this.src='https://via.placeholder.com/50'">
                                        <span>${m.team2}</span>
                                    </div>
                                </div>
                                <div class="match-details">
                                    <span><i class="fas fa-microphone"></i> ${m.commentator}</span>
                                    <span><i class="fas fa-tv"></i> ${m.channel}</span>
                                </div>
                            </div>
                        </div>`;
                   }).join('');
        }

        function toggleReminder(e, t1, t2, time) {
            e.stopPropagation();
            const id = t1 + time;
            const idx = reminders.findIndex(r => r.id === id);
            
            if (idx > -1) {
                reminders.splice(idx, 1);
                e.target.classList.remove('active');
            } else {
                reminders.push({ id, t1, t2, time, notified: false });
                e.target.classList.add('active');
                if(Notification.permission !== "granted") requestPermission();
            }
            localStorage.setItem('matchReminders', JSON.stringify(reminders));
        }

        // هذه الوظيفة تفحص المواعيد كل دقيقة وترسل تنبيهاً
        function startBackgroundCheck() {
            setInterval(() => {
                const now = new Date();
                const currentH = now.getHours();
                const currentM = now.getMinutes();

                reminders.forEach(r => {
                    const [h, m] = r.time.split(':');
                    // إذا حان الوقت ولم يتم إرسال التنبيه بعد
                    if (parseInt(h) === currentH && parseInt(m) === currentM && !r.notified) {
                        sendNotification(r);
                        r.notified = true;
                        localStorage.setItem('matchReminders', JSON.stringify(reminders));
                    }
                });
            }, 30000); // يفحص كل 30 ثانية
        }

        function sendNotification(r) {
            if (Notification.permission === "granted") {
                new Notification("بداية المباراة! ⚽", {
                    body: `بدأت الآن مباراة ${r.t1} ضد ${r.t2}`,
                    icon: "https://cdn-icons-png.flaticon.com/512/1827/1827347.png",
                    vibrate: [200, 100, 200]
                });
            }
        }

        window.onload = loadMatches;
    </script>
</body>
</html>
